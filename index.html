<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Áµ∂ÂØæÈü≥ÊÑü„Éà„É¨„Éº„Éã„É≥„Ç∞</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&display=swap');

        :root {
            --bg-color: #f0f8ff;
            --main-color: #ffb6c1;
            --accent-color: #ffd700;
            --text-color: #555;
            --correct-color: #32cd32;
            --wrong-color: #ff6347;
            --level-up-color: #9370db;
            --black-key-color: #555; /* ÈªíÈçµ„Éú„Çø„É≥„ÅÆËâ≤ */
        }

        body {
            font-family: 'Mochiy+Pop+One', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem 0; /* „Çπ„Éû„Éõ„ÅßÁ∏¶Èï∑„Å´„Å™„Å£„ÅüÊôÇÁî® */
            text-align: center;
            overflow-x: hidden;
        }

        .container {
            background-color: white;
            padding: 1.5rem 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px; /* Ê®™ÂπÖ„ÇíÂ∞ë„ÅóÂ∫É„Åí„Çã */
            position: relative;
            cursor: default;
        }

        .container.ready-for-next, .container.game-cleared {
            cursor: pointer;
        }

        h1 {
            color: var(--main-color);
            margin-top: 0;
        }

        .progress-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 1rem 0;
            height: 22px;
            overflow: hidden;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--accent-color);
            border-radius: 10px;
            transition: width 0.5s ease-in-out;
            text-align: center;
            line-height: 22px;
            color: white;
            font-size: 0.8rem;
            white-space: nowrap;
        }
        
        .info-panel {
            display: flex;
            justify-content: space-between;
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }

        #play-button {
            background-color: var(--main-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 100px;
            height: 100px;
            font-size: 3.5rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 1rem;
            line-height: 100px;
        }

        .choices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(65px, 1fr));
            gap: 8px;
            margin-bottom: 1rem;
        }

        .choice-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 0.8rem 0.2rem;
            border-radius: 10px;
            font-size: 1.2rem;
            font-family: 'Mochiy Pop One', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        /* ÈªíÈçµÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        .choice-btn.black-key {
            background-color: var(--black-key-color);
        }

        .feedback {
            font-size: 1.5rem;
            font-weight: bold;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .feedback .sub-text {
            font-size: 1rem;
            color: #888;
            margin-top: 5px;
        }

        .feedback.correct { color: var(--correct-color); animation: bounce 0.5s; }
        .feedback.wrong { color: var(--wrong-color); animation: shake 0.5s; }
        .feedback.level-up { color: var(--level-up-color); animation: bounce 0.8s; }
        
        #start-button, #restart-button {
            background-color: var(--main-color);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            font-family: 'Mochiy Pop One', sans-serif;
            margin-top: 1rem;
        }

        .game-screen, #clear-screen { display: none; }
        
        #clear-screen h1 {
            font-size: 2.5rem;
            color: var(--level-up-color);
            animation: bounce 2s infinite;
        }

        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-30px);} 60% {transform: translateY(-15px);} }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 10%, 30%, 50%, 70%, 90% {transform: translateX(-10px);} 20%, 40%, 60%, 80% {transform: translateX(10px);} }
    </style>
</head>
<body>

    <div class="container" id="container">
        
        <div id="start-screen">
            <h1>„Åä„Å®„ÅÇ„Å¶„Ç≤„Éº„É†ÔºÅ</h1>
            <p>‚ô™ „ÅÆ„Éú„Çø„É≥„Çí„Åä„Åó„Å¶„ÄÅ„Åç„Åì„Åà„Åü„Åä„Å®„Çí„ÅÇ„Å¶„Å¶„Å≠ÔºÅ</p>
            <button id="start-button">„ÅØ„Åò„ÇÅ„ÇãÔºÅ</button>
        </div>

        <div id="game-screen" class="game-screen">
            <h1>„Åì„ÅÆ„Åä„Å®„Å™„ÅÇ„Å´Ôºü</h1>
            <div class="info-panel">
                <div id="level">„É¨„Éô„É´: 1</div>
                <div id="score">„Çπ„Ç≥„Ç¢: 0</div>
            </div>
            <div class="progress-bar-container">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
            <button id="play-button">‚ô™</button>
            <div class="choices" id="choices"></div>
            <div id="feedback" class="feedback"></div>
        </div>
        
        <!-- ÂÖ®„ÇØ„É™„Ç¢ÁîªÈù¢ -->
        <div id="clear-screen">
            <h1>üéâ ÂÖ®„ÇØ„É™„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅüéâ</h1>
            <p>„Åç„Åø„ÅØ „Åä„Å®„ÅÆ„Éû„Çπ„Çø„Éº„Å†ÔºÅ</p>
            <p id="final-score" style="font-size: 1.5rem;"></p>
            <button id="restart-button">„ÇÇ„ÅÜ„ÅÑ„Å°„Å©„ÅÇ„Åù„Å∂</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script>
        // --- DOMË¶ÅÁ¥† ---
        const container = document.getElementById('container');
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const clearScreen = document.getElementById('clear-screen');
        const startButton = document.getElementById('start-button');
        const restartButton = document.getElementById('restart-button');
        const playButton = document.getElementById('play-button');
        const choicesContainer = document.getElementById('choices');
        const feedbackEl = document.getElementById('feedback');
        const scoreEl = document.getElementById('score');
        const levelEl = document.getElementById('level');
        const progressBar = document.getElementById('progress-bar');
        const finalScoreEl = document.getElementById('final-score');

        // --- Èü≥Â£∞Èñ¢ÈÄ£ ---
        let audioContext;
        function initAudioContext() {
            if (!audioContext) {
                try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
                catch (e) { alert('„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥„ÇíÂá∫„ÅôÊ©üËÉΩ„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ'); }
            }
        }

        // --- „Ç≤„Éº„É†Ë®≠ÂÆö ---
        const ALL_SCALES = {
            '„Éâ': 261.63, '„Éâ‚ôØ': 277.18, '„É¨': 293.66, '„É¨‚ôØ': 311.13, '„Éü': 329.63, '„Éï„Ç°': 349.23,
            '„Éï„Ç°‚ôØ': 369.99, '„ÇΩ': 392.00, '„ÇΩ‚ôØ': 415.30, '„É©': 440.00, '„É©‚ôØ': 466.16, '„Ç∑': 493.88
        };
        const ALL_NOTE_NAMES = Object.keys(ALL_SCALES);
        
        const LEVEL_CONFIG = {
            1: { notes: ['„Éâ', '„É¨', '„Éü'], required: 5 },
            2: { notes: ['„Éâ', '„É¨', '„Éü', '„Éï„Ç°', '„ÇΩ'], required: 5 },
            3: { notes: ['„Éâ', '„É¨', '„Éü', '„Éï„Ç°', '„ÇΩ', '„É©', '„Ç∑'], required: 5 },
            4: { notes: ALL_NOTE_NAMES, required: 5 } // ‚òÖ„É¨„Éô„É´4: ÂÖ®12Èü≥
        };
        const MAX_LEVEL = Object.keys(LEVEL_CONFIG).length;

        // --- „Ç≤„Éº„É†Áä∂ÊÖã ---
        let currentNote = '', score = 0, level = 1, consecutiveCorrect = 0, isAnswered = false;

        // --- Èü≥Â£∞ÂÜçÁîü ---
        function playPianoSound(freq) { /* Â§âÊõ¥„Å™„Åó */ }
        function playEffectSound(type) { /* Â§âÊõ¥„Å™„Åó„ÄÅÂæå„Åß„Éï„Ç°„É≥„Éï„Ç°„Éº„É¨ËøΩÂä† */ }
        function playFanfare() {
            if (!audioContext) return;
            const now = audioContext.currentTime;
            const t = 0.15; // Èü≥„ÅÆÈï∑„Åï„ÅÆÂü∫Êú¨Âçò‰Ωç
            const fanfareNotes = [
                { f: 392, d: t*2, w: now },         // „ÇΩ
                { f: 523, d: t*2, w: now + t*2 },   // „Éâ
                { f: 587, d: t,   w: now + t*4 },   // „É¨
                { f: 659, d: t,   w: now + t*5 },   // „Éü
                { f: 784, d: t*4, w: now + t*6 },   // „ÇΩ(È´ò)
                { f: 659, d: t*2, w: now + t*10 },  // „Éü
                { f: 784, d: t*4, w: now + t*12 },  // „ÇΩ(È´ò)
            ];

            fanfareNotes.forEach(note => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(note.f, note.w);
                osc.connect(gain);
                gain.connect(audioContext.destination);
                gain.gain.setValueAtTime(0.4, note.w);
                gain.gain.exponentialRampToValueAtTime(0.01, note.w + note.d);
                osc.start(note.w);
                osc.stop(note.w + note.d);
            });
        }
        
        // --- „Ç≤„Éº„É†ÈÄ≤Ë°å ---
        function generateQuestion() {
            isAnswered = false;
            container.classList.remove('ready-for-next', 'game-cleared');
            feedbackEl.innerHTML = '';
            feedbackEl.className = 'feedback';
            
            const config = LEVEL_CONFIG[level];
            const notes = config.notes;
            currentNote = notes[Math.floor(Math.random() * notes.length)];
            
            createChoiceButtons(notes);
            enableChoiceButtons(true);
            updateStatus();
        }
        
        function createChoiceButtons(notes) {
            choicesContainer.innerHTML = '';
            notes.forEach(name => {
                const btn = document.createElement('button');
                btn.textContent = name;
                btn.classList.add('choice-btn');
                if (name.includes('‚ôØ')) {
                    btn.classList.add('black-key'); // ÈªíÈçµ„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®
                }
                btn.dataset.note = name;
                choicesContainer.appendChild(btn);
            });
        }
        
        function checkAnswer(selectedNote) {
            if (isAnswered) return;
            isAnswered = true;
            enableChoiceButtons(false);
            
            const nextMsg = `<span class="sub-text">„Åå„ÇÅ„Çì„Çí„Çø„ÉÉ„Éó„Åó„Å¶„Å§„Åé„Å∏</span>`;
            
            if (selectedNote === currentNote) {
                // Ê≠£Ëß£
                score += 10;
                consecutiveCorrect++;
                const required = LEVEL_CONFIG[level].required;
                
                if (consecutiveCorrect >= required) {
                    // „É¨„Éô„É´„Ç¢„ÉÉ„Éó or ÂÖ®„ÇØ„É™„Ç¢
                    if (level < MAX_LEVEL) {
                        level++;
                        consecutiveCorrect = 0;
                        feedbackEl.innerHTML = `„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ„É¨„Éô„É´${level}„Å´„Å™„Å£„Åü„ÇàÔºÅ üöÄ ${nextMsg}`;
                        feedbackEl.classList.add('level-up');
                        playEffectSound('levelUp');
                        playConfetti(true);
                    } else {
                        // ÂÖ®„ÇØ„É™„Ç¢Âá¶ÁêÜ
                        gameClear();
                        return;
                    }
                } else {
                    feedbackEl.innerHTML = `„Åõ„ÅÑ„Åã„ÅÑÔºÅ„Åô„Åî„ÅÑÔºÅ ‚ú® ${nextMsg}`;
                    feedbackEl.classList.add('correct');
                    playEffectSound('correct');
                    playConfetti(false);
                }
            } else {
                // ‰∏çÊ≠£Ëß£
                consecutiveCorrect = 0;
                feedbackEl.innerHTML = `„Åñ„Çì„Å≠„ÇìÔºÅ„Åì„Åü„Åà„ÅØ„Äå${currentNote}„Äç„Å†„Çà ${nextMsg}`;
                feedbackEl.classList.add('wrong');
                playEffectSound('wrong');
            }
            updateStatus();
            container.classList.add('ready-for-next');
        }

        function updateStatus() {
            scoreEl.textContent = `„Çπ„Ç≥„Ç¢: ${score}`;
            levelEl.textContent = `„É¨„Éô„É´: ${level}`;
            const required = LEVEL_CONFIG[level].required;
            const progress = (consecutiveCorrect / required) * 100;
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${consecutiveCorrect} / ${required} „Çå„Çì„Åû„Åè„Åõ„ÅÑ„Åã„ÅÑ`;
        }

        function gameClear() {
            gameScreen.style.display = 'none';
            clearScreen.style.display = 'block';
            finalScoreEl.textContent = `ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: ${score}`;
            container.classList.add('game-cleared');
            playFanfare();
            playConfetti(true, 3000); // 3ÁßíÈñìÁ¥ôÂêπÈõ™„ÇíÈôç„Çâ„Åõ„Çã
        }
        
        function startGame() {
            score = 0;
            level = 1;
            consecutiveCorrect = 0;
            initAudioContext();
            startScreen.style.display = 'none';
            clearScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            container.classList.remove('game-cleared');
            generateQuestion();
        }
        
        function enableChoiceButtons(e){document.querySelectorAll('.choice-btn').forEach(b=>b.disabled=!e);}
        function playConfetti(isBig, duration) {
            const end = Date.now() + (duration || 0);
            (function frame() {
                confetti({
                    particleCount: isBig ? 7 : 2,
                    angle: isBig ? 90 : 60,
                    spread: isBig ? 180 : 55,
                    origin: { x: isBig ? 0.5 : 0, y: 0.6 },
                });
                confetti({
                    particleCount: isBig ? 7 : 2,
                    angle: isBig ? 90 : 120,
                    spread: isBig ? 180 : 55,
                    origin: { x: isBig ? 0.5 : 1, y: 0.6 },
                });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }

        // --- „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº ---
        startButton.addEventListener('click', startGame);
        restartButton.addEventListener('click', startGame);
        playButton.addEventListener('click', () => !isAnswered && playPianoSound(ALL_SCALES[currentNote]));
        choicesContainer.addEventListener('click', e => e.target.classList.contains('choice-btn') && checkAnswer(e.target.dataset.note));
        container.addEventListener('click', e => {
            if (isAnswered && !e.target.closest('button')) generateQuestion();
            if (container.classList.contains('game-cleared') && !e.target.closest('button')) startGame();
        });
        
        // --- „Åì„Åì„Åã„Çâ‰∏ã„ÅØÂ§âÊõ¥„ÅÆ„Å™„ÅÑÈñ¢Êï∞ ---
        // playPianoSound „Å® playEffectSound „ÅØÂÖÉ„ÅÆ„Ç≥„Éº„Éâ„Å®Âêå„Åò„ÇÇ„ÅÆ„Çí„Åì„Åì„Å´„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ
        function playPianoSound(frequency) {
            if (!audioContext) return;
            const now = audioContext.currentTime;
            const gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.5, now + 0.05);
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + 1.5);
            [1, 2, 3].forEach(harmonic => {
                const osc = audioContext.createOscillator();
                const overtoneGain = audioContext.createGain();
                osc.type = harmonic === 1 ? 'triangle' : 'sine';
                osc.frequency.setValueAtTime(frequency * harmonic, now);
                overtoneGain.gain.setValueAtTime(1 / (harmonic * 2), now);
                osc.connect(overtoneGain).connect(gainNode);
                osc.start(now);
                osc.stop(now + 1.5);
            });
            gainNode.connect(audioContext.destination);
        }

        function playEffectSound(type) {
            if (!audioContext) return;
            const now = audioContext.currentTime;
            if (type === 'levelUp') {
                [880, 1046, 1318].forEach((freq, i) => {
                    const o = audioContext.createOscillator(), g = audioContext.createGain();
                    o.type = 'sine'; o.frequency.value = freq;
                    o.connect(g).connect(audioContext.destination);
                    g.gain.setValueAtTime(0, now);
                    g.gain.linearRampToValueAtTime(0.2, now + i * 0.1 + 0.05);
                    g.gain.exponentialRampToValueAtTime(0.001, now + i * 0.1 + 0.3);
                    o.start(now + i * 0.1); o.stop(now + i * 0.1 + 0.3);
                });
                return;
            }
            const osc = audioContext.createOscillator(), gain = audioContext.createGain();
            osc.connect(gain); gain.connect(audioContext.destination);
            if (type === 'correct') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(523.25, now);
                osc.frequency.linearRampToValueAtTime(1046.50, now + 0.1);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(130.81, now);
            }
            gain.gain.setValueAtTime(0.3, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
            osc.start(now); osc.stop(now + 0.5);
        }
    </script>
</body>
</html>