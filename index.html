<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S0M4L8GDW3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-S0M4L8GDW3');
</script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Åä„Å®„ÅÇ„Å¶„Éû„Ç∏„ÉÉ„ÇØÔºÅ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&display=swap');

        :root {
            /* Â§¢„ÅÆÂõΩ„Éë„É¨„ÉÉ„Éà */
            --bg-gradient-start: #ffdde1;
            --bg-gradient-end: #ee9ca7;
            --card-bg: rgba(255, 255, 255, 0.95);
            
            --primary-pink: #ff6b81;
            --primary-pop: #ff4757;
            --accent-yellow: #f1c40f;
            --accent-orange: #ffa502;
            --magic-purple: #a29bfe;
            --sky-blue: #70a1ff;
            
            --text-main: #2f3542;
            --text-sub: #57606f;
            
            --correct-green: #2ed573;
            --wrong-red: #ff4757;
        }

        body {
            font-family: 'Mochiy+Pop+One', sans-serif;
            background: linear-gradient(-45deg, #ff9a9e, #fad0c4, #fad0c4, #a18cd1);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            text-align: center;
            overflow-x: hidden;
            /* ËÉåÊôØ„Å´„Éâ„ÉÉ„ÉàÊüÑ„ÇíÈáç„Å≠„Çã */
            background-image: radial-gradient(rgba(255,255,255,0.4) 2px, transparent 2px), linear-gradient(-45deg, #ff9a9e, #a18cd1);
            background-size: 30px 30px, 400% 400%;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 35px;
            box-shadow: 
                0 20px 50px rgba(0,0,0,0.15),
                0 0 0 8px rgba(255,255,255,0.5); /* Â§ñÂÅ¥„ÅÆ„Åµ„Å°„Å©„Çä */
            width: 100%;
            max-width: 550px;
            position: relative;
            cursor: default;
            backdrop-filter: blur(5px);
            border: 4px solid #fff;
            animation: floatContainer 6s ease-in-out infinite;
        }

        @keyframes floatContainer {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .container.ready-for-next, .container.game-cleared { cursor: pointer; }

        h1 { 
            color: var(--primary-pop);
            margin-top: 0;
            font-size: 2rem;
            text-shadow: 2px 2px 0px #fff, 4px 4px 0px rgba(0,0,0,0.1);
            letter-spacing: 0.1rem;
        }

        p { color: var(--text-sub); font-size: 1.1rem; }

        /* „Çπ„Ç≥„Ç¢„Éª„É¨„Éô„É´Ë°®Á§∫ */
        .info-panel { 
            display: flex; 
            justify-content: space-around; 
            font-size: 1.1rem; 
            margin-bottom: 0.8rem;
            background: #fff;
            padding: 10px;
            border-radius: 20px;
            border: 2px solid #f1f2f6;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        #level, #score { font-weight: bold; color: var(--magic-purple); }

        /* „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº */
        .progress-bar-container { 
            width: 100%; 
            background-color: #dfe4ea; 
            border-radius: 15px; 
            margin: 1rem 0; 
            height: 26px; 
            overflow: hidden; 
            border: 2px solid #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .progress-bar { 
            width: 0%; 
            height: 100%; 
            background: repeating-linear-gradient(
                45deg,
                var(--accent-yellow),
                var(--accent-yellow) 10px,
                var(--accent-orange) 10px,
                var(--accent-orange) 20px
            );
            border-radius: 15px; 
            transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-align: center; 
            line-height: 26px; 
            color: #fff; 
            font-size: 0.9rem; 
            white-space: nowrap; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            font-weight: bold;
        }

        /* „Éó„É¨„Ç§„Éú„Çø„É≥ÔºàÈ≠îÊ≥ï„ÅÆ„Éú„Çø„É≥Ôºâ */
        #play-button { 
            background: radial-gradient(circle at 30% 30%, #ff9ff3, #f368e0);
            color: white; 
            border: 4px solid #fff; 
            border-radius: 50%; 
            width: 110px; 
            height: 110px; 
            font-size: 4rem; 
            cursor: pointer; 
            transition: all 0.2s; 
            margin-bottom: 1.5rem; 
            line-height: 100px; 
            box-shadow: 
                0 10px 20px rgba(243, 104, 224, 0.4),
                inset 0 5px 10px rgba(255,255,255,0.5);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            position: relative;
        }
        #play-button::after {
            content: '‚ô™';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%;
            background: transparent;
        }
        #play-button:active { transform: scale(0.95) translateY(5px); box-shadow: 0 5px 10px rgba(243, 104, 224, 0.4); }

        /* „Éë„É´„Çπ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .pulse-btn { animation: pulse-magic 1.5s infinite; }
        @keyframes pulse-magic {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(243, 104, 224, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 30px rgba(243, 104, 224, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(243, 104, 224, 0); }
        }

        /* ÈÅ∏ÊäûËÇ¢„Éú„Çø„É≥Ôºà„Ç≠„É£„É≥„Éá„Ç£È¢®Ôºâ */
        .choices { display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 12px; margin-bottom: 1.5rem; }
        .choice-btn { 
            background: linear-gradient(to bottom, #7bed9f, #2ed573);
            color: white; 
            border: none; 
            padding: 1rem 0.2rem; 
            border-radius: 15px; 
            font-size: 1.3rem; 
            font-family: 'Mochiy Pop One', sans-serif; 
            cursor: pointer; 
            transition: all 0.1s; 
            box-shadow: 0 6px 0 #218c74, 0 10px 10px rgba(0,0,0,0.1);
            text-shadow: 1px 1px 0 rgba(0,0,0,0.2);
            position: relative;
            top: 0;
        }
        .choice-btn:active { 
            top: 6px; 
            box-shadow: 0 0 0 #218c74, inset 0 2px 5px rgba(0,0,0,0.2); 
        }
        
        .choice-btn.black-key { 
            background: linear-gradient(to bottom, #57606f, #2f3542);
            box-shadow: 0 6px 0 #1e272e, 0 10px 10px rgba(0,0,0,0.1);
        }
        .choice-btn.black-key:active { box-shadow: 0 0 0 #1e272e, inset 0 2px 5px rgba(0,0,0,0.5); }
        
        /* „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØË°®Á§∫ */
        .feedback { font-size: 1.5rem; font-weight: bold; min-height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-shadow: 2px 2px 0 #fff; }
        .feedback .sub-text { font-size: 1rem; color: var(--text-sub); margin-top: 5px; background: rgba(255,255,255,0.8); padding: 5px 15px; border-radius: 20px; }

        .feedback.correct { color: var(--correct-green); animation: bounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .feedback.wrong { color: var(--wrong-red); animation: shake 0.5s; }
        .feedback.level-up { color: var(--magic-purple); animation: bounce 0.8s; font-size: 1.8rem; }

        /* „Çπ„Çø„Éº„Éà„Éª„É™„Çπ„Çø„Éº„Éà„Éú„Çø„É≥ */
        #start-button, #restart-button { 
            background: linear-gradient(to bottom, #ff9ff3, #f368e0);
            color: white; 
            border: none; 
            padding: 1.2rem 3rem; 
            border-radius: 50px; 
            font-size: 1.6rem; 
            cursor: pointer; 
            font-family: 'Mochiy Pop One', sans-serif; 
            margin-top: 1.5rem; 
            box-shadow: 0 8px 0 #c445b0, 0 15px 20px rgba(0,0,0,0.2);
            text-shadow: 2px 2px 0 rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        #start-button:active, #restart-button:active {
            transform: translateY(8px);
            box-shadow: 0 0 0 #c445b0, inset 0 2px 5px rgba(0,0,0,0.2);
        }

        .game-screen, #clear-screen, #piano-container { display: none; }
        #clear-screen h1 { font-size: 2.8rem; color: var(--accent-orange); animation: floatContainer 3s infinite; }

        /* „Éî„Ç¢„ÉéÈçµÁõ§Ôºà„Åä„ÇÇ„Å°„ÇÉÈ¢®Ôºâ */
        #piano-container { padding: 1.5rem 0; margin: 0 auto; width: 100%; max-width: 480px; }
        .piano-keyboard { display: flex; position: relative; width: 100%; height: 200px; background: #333; padding: 10px; border-radius: 15px; box-shadow: 0 15px 30px rgba(0,0,0,0.3); box-sizing: border-box; }
        .key { border-radius: 0 0 10px 10px; cursor: pointer; transition: all 0.1s ease; box-sizing: border-box; }
        .key.white { 
            flex: 1; height: 100%; background: linear-gradient(to bottom, #fff 0%, #f1f2f6 100%); 
            border: 1px solid #ccc; margin: 0 2px; box-shadow: 0 5px 0 #bdc3c7; 
        }
        .key.black { 
            position: absolute; width: 8%; height: 60%; 
            background: linear-gradient(to bottom, #57606f, #2f3542);
            color: white; z-index: 2; 
            border: 1px solid #000; border-radius: 0 0 8px 8px;
            box-shadow: 2px 5px 5px rgba(0,0,0,0.4);
        }
        .key.white:active { background: #dfe4ea; transform: translateY(5px); box-shadow: none; }
        .key.black:active { background: #222; transform: translateY(3px); box-shadow: none; }
        
        .key.inactive { opacity: 0.5; cursor: not-allowed; pointer-events: none; filter: grayscale(100%); }
        .key.correct-key { background: #2ed573 !important; border-color: #2ed573 !important; box-shadow: 0 0 20px #2ed573 !important; transform: translateY(5px); }
        .key.wrong-key { background: #ff4757 !important; border-color: #ff4757 !important; transform: translateY(5px); }

        @keyframes bounce { 0%,100%{transform:scale(1)} 50%{transform:scale(1.2)} }
        @keyframes shake { 0%,100%{transform:translateX(0)} 10%,50%,90%{transform:translateX(-8px) rotate(-5deg)} 30%,70%{transform:translateX(8px) rotate(5deg)} }
    </style>
</head>
<body>

    <div class="container" id="container">
        <div id="start-screen">
            <h1>üè∞ „Åä„Å®„ÅÇ„Å¶<br>„Éû„Ç∏„ÉÉ„ÇØÔºÅ üé°</h1>
            <p>‚ô™ „ÅÆ„Éú„Çø„É≥„Çí„Åä„Åó„Å¶<br>„Åç„Åì„Åà„Åü„Äå„Åä„Å®„Äç„Çí„ÅÇ„Å¶„Å¶„Å≠ÔºÅ</p>
            <button id="start-button">„ÅØ„Åò„ÇÅ„ÇãÔºÅ</button>
        </div>

        <div id="game-screen" class="game-screen">
            <div class="info-panel">
                <div id="level"></div><div id="score"></div>
            </div>
            <h1>„Åì„ÅÆ„Åä„Å®„Å™„ÅÇ„Å´Ôºü</h1>
            <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
            <button id="play-button">‚ô™</button>
            <div class="choices" id="choices"></div>
            <div id="piano-container">
                <div class="piano-keyboard" id="piano-keyboard">
                    <div class="key white" data-note="„Éâ"></div> <div class="key white" data-note="„É¨"></div>
                    <div class="key white" data-note="„Éü"></div> <div class="key white" data-note="„Éï„Ç°"></div>
                    <div class="key white" data-note="„ÇΩ"></div> <div class="key white" data-note="„É©"></div>
                    <div class="key white" data-note="„Ç∑"></div> <div class="key white" data-note="„Éâ2"></div>
                    <div class="key black" data-note="„Éâ‚ôØ" style="left: 8.75%;"></div>
                    <div class="key black" data-note="„É¨‚ôØ" style="left: 21.25%;"></div>
                    <div class="key black" data-note="„Éï„Ç°‚ôØ" style="left: 46.25%;"></div>
                    <div class="key black" data-note="„ÇΩ‚ôØ" style="left: 58.75%;"></div>
                    <div class="key black" data-note="„É©‚ôØ" style="left: 71.25%;"></div>
                </div>
            </div>
            <div id="feedback" class="feedback"></div>
        </div>
        
        <div id="clear-screen">
            <h1>üëë ÂÖ®„ÇØ„É™<br>„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅüëë</h1>
            <p>„Åç„Åø„ÅØ „Åä„Å®„ÅÆ„Éû„Çπ„Çø„Éº„Å†ÔºÅ<br>„Åæ„Åª„ÅÜ„ÅÆ‰∏ñÁïå„ÅØ „Åç„Åø„ÅÆ„ÇÇ„ÅÆÔºÅ</p>
            <p id="final-score" style="font-size: 1.5rem; color: #ff4757; font-weight: bold;"></p>
            <button id="restart-button">„ÇÇ„ÅÜ„ÅÑ„Å°„Å©„ÅÇ„Åù„Å∂</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script>
        const ui = { container: document.getElementById('container'), startScreen: document.getElementById('start-screen'), gameScreen: document.getElementById('game-screen'), clearScreen: document.getElementById('clear-screen'), startButton: document.getElementById('start-button'), restartButton: document.getElementById('restart-button'), playButton: document.getElementById('play-button'), choices: document.getElementById('choices'), feedback: document.getElementById('feedback'), score: document.getElementById('score'), level: document.getElementById('level'), progressBar: document.getElementById('progress-bar'), finalScore: document.getElementById('final-score'), pianoContainer: document.getElementById('piano-container'), pianoKeyboard: document.getElementById('piano-keyboard') };
        let audioContext;
        function initAudioContext() { if (!audioContext) try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { alert('„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥„ÇíÂá∫„ÅôÊ©üËÉΩ„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ'); }}
        const ALL_SCALES = { '„Éâ': 261.63, '„Éâ‚ôØ': 277.18, '„É¨': 293.66, '„É¨‚ôØ': 311.13, '„Éü': 329.63, '„Éï„Ç°': 349.23, '„Éï„Ç°‚ôØ': 369.99, '„ÇΩ': 392.00, '„ÇΩ‚ôØ': 415.30, '„É©': 440.00, '„É©‚ôØ': 466.16, '„Ç∑': 493.88, '„Éâ2': 523.25 };
        const ALL_NOTE_NAMES = Object.keys(ALL_SCALES);
        const LEVEL_CONFIG = { 1: { notes: ['„Éâ', '„É¨', '„Éü'], required: 5, ui: 'buttons' }, 2: { notes: ['„Éâ', '„É¨', '„Éü', '„Éï„Ç°', '„ÇΩ'], required: 5, ui: 'buttons' }, 3: { notes: ['„Éâ', '„É¨', '„Éü', '„Éï„Ç°', '„ÇΩ', '„É©', '„Ç∑'], required: 5, ui: 'buttons' }, 4: { notes: ALL_NOTE_NAMES.slice(0, 12), required: 5, ui: 'buttons' }, 5: { notes: ['„Éâ', '„É¨', '„Éü'], required: 5, ui: 'keyboard' }, 6: { notes: ['„Éâ', '„É¨', '„Éü', '„Éï„Ç°', '„ÇΩ'], required: 5, ui: 'keyboard' }, 7: { notes: ALL_NOTE_NAMES.filter(n => !n.includes('‚ôØ')), required: 5, ui: 'keyboard' }, 8: { notes: ALL_NOTE_NAMES, required: 5, ui: 'keyboard' } };
        const MAX_LEVEL = Object.keys(LEVEL_CONFIG).length;
        let state = { currentNote: '', score: 0, level: 1, consecutiveCorrect: 0, isAnswered: false };

        function generateQuestion() {
            Object.assign(state, { isAnswered: false });
            ui.container.classList.remove('ready-for-next', 'game-cleared');
            ui.feedback.innerHTML = ''; ui.feedback.className = 'feedback';
            const config = LEVEL_CONFIG[state.level];
            state.currentNote = config.notes[Math.floor(Math.random() * config.notes.length)];
            setupUIForLevel();
            updateStatus();
        }

        function setupUIForLevel() {
            const config = LEVEL_CONFIG[state.level];
            const isKeyboardView = config.ui === 'keyboard';
            ui.choices.style.display = isKeyboardView ? 'none' : 'grid';
            ui.pianoContainer.style.display = isKeyboardView ? 'block' : 'none';
            if (isKeyboardView) { updatePianoKeyboard(config.notes); } 
            else { createChoiceButtons(config.notes); }
        }

        function checkAnswer(selectedNote) {
            if (state.isAnswered) return;
            state.isAnswered = true;
            const isCorrect = selectedNote === state.currentNote;
            
            if (LEVEL_CONFIG[state.level].ui === 'keyboard') { highlightPianoKey(selectedNote, isCorrect); }

            if (isCorrect) {
                state.score += 10; state.consecutiveCorrect++;
                if (state.consecutiveCorrect >= LEVEL_CONFIG[state.level].required) {
                    if (state.level < MAX_LEVEL) {
                        state.level++; state.consecutiveCorrect = 0;
                        let msg = `„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ„É¨„Éô„É´${state.level}„Å†ÔºÅ üöÄ`;
                        if (LEVEL_CONFIG[state.level].ui === 'keyboard' && LEVEL_CONFIG[state.level - 1].ui === 'buttons') {
                            msg = '„Åô„Åî„ÅÑÔºÅ„Å§„Åé„ÅØ „Åë„Çì„Å∞„Çì „Åß„Åì„Åü„Åà„Å¶„Å≠ÔºÅüéπ';
                        }
                        ui.feedback.innerHTML = `${msg}`;
                        ui.feedback.classList.add('level-up');
                        playEffectSound('levelUp'); playConfetti(true);
                    } else {
                        ui.feedback.innerHTML = `üéâüéâüéâ ÂÖ®„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅ üéâüéâüéâ`;
                        ui.feedback.classList.add('level-up');
                        gameClear(); return;
                    }
                } else {
                    ui.feedback.innerHTML = `„Åõ„ÅÑ„Åã„ÅÑÔºÅ„Åô„Åî„ÅÑÔºÅ ‚ú®`;
                    ui.feedback.classList.add('correct');
                    playEffectSound('correct'); playConfetti(false);
                }

                // Ê≠£Ëß£ÊôÇ„ÅØ1.5ÁßíÂæå„Å´Ëá™Âãï„ÅßÊ¨°„Å∏
                setTimeout(() => {
                    if (state.isAnswered) {
                        generateQuestion();
                    }
                }, 1500);

            } else {
                state.consecutiveCorrect = 0;
                const nextMsg = `<span class="sub-text">‚ô™ „Çí„Åä„Åó„Å¶ „Å§„Åé„ÅÆ„Åä„Å®„Å∏ÔºÅ</span>`;
                ui.feedback.innerHTML = `„Åñ„Çì„Å≠„ÇìÔºÅ„Åì„Åü„Åà„ÅØ„Äå${state.currentNote}„Äç„Å†„Çà ${nextMsg}`;
                ui.feedback.classList.add('wrong');
                playEffectSound('wrong');
            }
            updateStatus();
            ui.container.classList.add('ready-for-next');
        }

        function gameClear() {
            playFanfare();
            playConfetti(true, 3000);
            setTimeout(() => {
                ui.gameScreen.style.display = 'none';
                ui.clearScreen.style.display = 'block';
                ui.finalScore.textContent = `ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: ${state.score}`;
                ui.container.classList.add('game-cleared');
            }, 3000);
        }

        function updatePianoKeyboard(activeNotes) { const keys = ui.pianoKeyboard.querySelectorAll('.key'); keys.forEach(key => { key.classList.remove('inactive', 'correct-key', 'wrong-key'); if (!activeNotes.includes(key.dataset.note)) { key.classList.add('inactive'); } }); }
        function highlightPianoKey(selectedNote, isCorrect) { const correctKey = ui.pianoKeyboard.querySelector(`[data-note="${state.currentNote}"]`); if (isCorrect) { if(correctKey) correctKey.classList.add('correct-key'); } else { const selectedKey = ui.pianoKeyboard.querySelector(`[data-note="${selectedNote}"]`); if(selectedKey) selectedKey.classList.add('wrong-key'); if(correctKey) correctKey.classList.add('correct-key'); } }
        function createChoiceButtons(notes) { ui.choices.innerHTML = ''; notes.forEach(name => { const btn = document.createElement('button'); btn.textContent = name; btn.className = 'choice-btn'; if (name.includes('‚ôØ')) btn.classList.add('black-key'); btn.dataset.note = name; ui.choices.appendChild(btn); }); }
        function updateStatus() { ui.score.textContent = `„Çπ„Ç≥„Ç¢: ${state.score}`; ui.level.textContent = `„É¨„Éô„É´: ${state.level}`; const required = LEVEL_CONFIG[state.level].required; const progress = (state.consecutiveCorrect / required) * 100; ui.progressBar.style.width = `${progress}%`; ui.progressBar.textContent = `${state.consecutiveCorrect} / ${required} „Çå„Çì„Åû„Åè„Åõ„ÅÑ„Åã„ÅÑ`; }
        
        function startGame() { 
            Object.assign(state, { score: 0, level: 1, consecutiveCorrect: 0 }); 
            initAudioContext(); 
            ui.startScreen.style.display = 'none'; 
            ui.clearScreen.style.display = 'none'; 
            ui.gameScreen.style.display = 'block'; 
            ui.container.classList.remove('game-cleared'); 
            generateQuestion();
            
            // ÊúÄÂàù„ÅÆ1ÂïèÁõÆ„Å†„Åë„Éú„Çø„É≥„ÇíÂÖâ„Çâ„Åõ„ÄÅ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫„Åô„Çã
            ui.playButton.classList.add('pulse-btn');
            ui.feedback.innerHTML = '<span style="color:#ff6b81">‚ô™ „Éú„Çø„É≥„Çí„Åä„Åó„Å¶ „Åä„Å®„Çí„Åç„Åì„ÅÜÔºÅ</span>';
        }
        
        ui.startButton.addEventListener('click', startGame);
        ui.restartButton.addEventListener('click', startGame);

        ui.playButton.addEventListener('click', () => {
            ui.playButton.classList.remove('pulse-btn');
            if (ui.feedback.textContent.includes('„Åä„Å®„Çí„Åç„Åì„ÅÜ')) ui.feedback.innerHTML = '';

            if (state.isAnswered) {
                generateQuestion();
                setTimeout(() => {
                     playPianoSound(ALL_SCALES[state.currentNote]);
                }, 50);
            } else {
                playPianoSound(ALL_SCALES[state.currentNote]);
            }
        });

        ui.choices.addEventListener('click', e => { if (e.target.classList.contains('choice-btn')) checkAnswer(e.target.dataset.note); });
        ui.pianoKeyboard.addEventListener('click', e => { if (state.isAnswered || !e.target.classList.contains('key') || e.target.classList.contains('inactive')) return; const note = e.target.dataset.note; playPianoSound(ALL_SCALES[note]); checkAnswer(note); });
        
        ui.container.addEventListener('click', e => { 
            if (state.isAnswered && !e.target.closest('button') && !e.target.closest('.key')) generateQuestion(); 
            if (ui.container.classList.contains('game-cleared') && !e.target.closest('button')) startGame(); 
        });
        
        function playPianoSound(frequency) { if (!audioContext) return; const now = audioContext.currentTime; const gainNode = audioContext.createGain(); gainNode.gain.setValueAtTime(0, now); gainNode.gain.linearRampToValueAtTime(0.5, now + 0.05); gainNode.gain.exponentialRampToValueAtTime(0.001, now + 1.5); [1, 2, 3].forEach(h => { const o = audioContext.createOscillator(), g = audioContext.createGain(); o.type = h === 1 ? 'triangle' : 'sine'; o.frequency.setValueAtTime(frequency * h, now); g.gain.setValueAtTime(1 / (h * 2), now); o.connect(g).connect(gainNode); o.start(now); o.stop(now + 1.5); }); gainNode.connect(audioContext.destination); }
        function playEffectSound(type) { if(!audioContext)return; const n=audioContext.currentTime; if(type==='levelUp'){[880,1046,1318].forEach((f,i)=>{const o=audioContext.createOscillator(),g=audioContext.createGain();o.type='sine';o.frequency.value=f;o.connect(g).connect(audioContext.destination);g.gain.setValueAtTime(0,n);g.gain.linearRampToValueAtTime(.2,n+i*.1+.05);g.gain.exponentialRampToValueAtTime(.001,n+i*.1+.3);o.start(n+i*.1);o.stop(n+i*.1+.3)});return}const o=audioContext.createOscillator(),g=audioContext.createGain();o.connect(g);g.connect(audioContext.destination);if(type==='correct'){o.type='sine';o.frequency.setValueAtTime(523.25,n);o.frequency.linearRampToValueAtTime(1046.5,n+.1)}else if(type==='wrong'){o.type='sawtooth';o.frequency.setValueAtTime(130.81,n)}g.gain.setValueAtTime(.3,n);g.gain.exponentialRampToValueAtTime(.001,n+.5);o.start(n);o.stop(n+.5)}
        function playFanfare(){ if(!audioContext)return; const n=audioContext.currentTime,t=.15,f=[{f:392,d:t*2,w:n},{f:523,d:t*2,w:n+t*2},{f:587,d:t,w:n+t*4},{f:659,d:t,w:n+t*5},{f:784,d:t*4,w:n+t*6},{f:659,d:t*2,w:n+t*10},{f:784,d:t*4,w:n+t*12}];f.forEach(note=>{const o=audioContext.createOscillator(),g=audioContext.createGain();o.type='triangle';o.frequency.setValueAtTime(note.f,note.w);o.connect(g).connect(audioContext.destination);g.gain.setValueAtTime(.4,note.w);g.gain.exponentialRampToValueAtTime(.01,note.w+note.d);o.start(note.w);o.stop(note.w+note.d)})}
        function playConfetti(isBig, duration) { const end = Date.now() + (duration || 0); (function frame() { const angle = isBig ? 90 : 60, spread = isBig ? 180 : 55, particleCount = isBig ? 7 : 2; confetti({ particleCount, angle, spread, origin: { x: isBig ? 0.5 : 0, y: 0.6 } }); confetti({ particleCount, angle: 180 - angle, spread, origin: { x: isBig ? 0.5 : 1, y: 0.6 } }); if (Date.now() < end) requestAnimationFrame(frame); }());}
    </script>
</body>
</html>